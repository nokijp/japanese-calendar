<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">JapaneseCalendar</span><span class="hs-operator">.</span><span class="hs-identifier">TempoCalendar</span><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#TempoMonthType"><span class="hs-identifier hs-type">TempoMonthType</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#TempoMonth"><span class="hs-identifier hs-type">TempoMonth</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#TempoDate"><span class="hs-identifier hs-type">TempoDate</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#monthNumber"><span class="hs-identifier hs-var">monthNumber</span></a><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#isLeapMonth"><span class="hs-identifier hs-var">isLeapMonth</span></a><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#nextTempoMonthType"><span class="hs-identifier hs-var">nextTempoMonthType</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#previousTempoMonthType"><span class="hs-identifier hs-var">previousTempoMonthType</span></a><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#tempoDate"><span class="hs-identifier hs-var">tempoDate</span></a><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Calendar</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Time.JapaneseCalendar.Internal.Moon.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">JapaneseCalendar</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Moon</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Time.JapaneseCalendar.JapaneseName.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">JapaneseCalendar</span><span class="hs-operator">.</span><span class="hs-identifier">JapaneseName</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Time.JapaneseCalendar.SolarTerm.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">JapaneseCalendar</span><span class="hs-operator">.</span><span class="hs-identifier">SolarTerm</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">LocalTime</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-comment">-- | a type of a month in the Tempo calendar</span><span>
</span><a name="line-27"></a><span class="hs-keyword">data</span><span> </span><a name="TempoMonthType"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#TempoMonthType"><span class="hs-identifier">TempoMonthType</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-28"></a><span>    </span><a name="Mutsuki"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Mutsuki"><span class="hs-identifier">Mutsuki</span></a></a><span>  </span><span class="hs-comment">-- ^ &#30566;&#26376;</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Kisaragi"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Kisaragi"><span class="hs-identifier">Kisaragi</span></a></a><span>  </span><span class="hs-comment">-- ^ &#22914;&#26376;</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Yayoi"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Yayoi"><span class="hs-identifier">Yayoi</span></a></a><span>  </span><span class="hs-comment">-- ^ &#24357;&#29983;</span><span>
</span><a name="line-31"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Uzuki"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Uzuki"><span class="hs-identifier">Uzuki</span></a></a><span>  </span><span class="hs-comment">-- ^ &#21359;&#26376;</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Satsuki"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Satsuki"><span class="hs-identifier">Satsuki</span></a></a><span>  </span><span class="hs-comment">-- ^ &#30352;&#26376;</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Minazuki"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Minazuki"><span class="hs-identifier">Minazuki</span></a></a><span>  </span><span class="hs-comment">-- ^ &#27700;&#28961;&#26376;</span><span>
</span><a name="line-34"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Fumizuki"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Fumizuki"><span class="hs-identifier">Fumizuki</span></a></a><span>  </span><span class="hs-comment">-- ^ &#25991;&#26376;</span><span>
</span><a name="line-35"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Hazuki"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Hazuki"><span class="hs-identifier">Hazuki</span></a></a><span>  </span><span class="hs-comment">-- ^ &#33865;&#26376;</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Nagatsuki"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Nagatsuki"><span class="hs-identifier">Nagatsuki</span></a></a><span>  </span><span class="hs-comment">-- ^ &#38263;&#26376;</span><span>
</span><a name="line-37"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Kannazuki"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Kannazuki"><span class="hs-identifier">Kannazuki</span></a></a><span>  </span><span class="hs-comment">-- ^ &#31070;&#28961;&#26376;</span><span>
</span><a name="line-38"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Shimotsuki"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Shimotsuki"><span class="hs-identifier">Shimotsuki</span></a></a><span>  </span><span class="hs-comment">-- ^ &#38684;&#26376;</span><span>
</span><a name="line-39"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Shiwasu"><a href="Data.Time.JapaneseCalendar.TempoCalendar.html#Shiwasu"><span class="hs-identifier">Shiwasu</span></a></a><span>  </span><span class="hs-comment">-- ^ &#24107;&#36208;</span><span>
</span><a name="line-40"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bounded</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-identifier hs-var">derivingJapaneseNameBoundedEnum</span><span> </span><span class="hs-char">''TempoMonthType
  [&quot;&#30566;&#26376;&quot;, &quot;&#22914;&#26376;&quot;, &quot;&#24357;&#29983;&quot;, &quot;&#21359;&#26376;&quot;, &quot;&#30352;&#26376;&quot;, &quot;&#27700;&#28961;&#26376;&quot;, &quot;&#25991;&#26376;&quot;, &quot;&#33865;&#26376;&quot;, &quot;&#38263;&#26376;&quot;, &quot;&#31070;&#28961;&#26376;&quot;, &quot;&#38684;&#26376;&quot;, &quot;&#24107;&#36208;&quot;]

-- | a month in the Tempo calendar
data TempoMonth =
    CommonMonth { tempoMonthType :: TempoMonthType }
  | LeapMonth { tempoMonthType :: TempoMonthType }
    deriving (Show, Eq)

instance Ord TempoMonth where
  (CommonMonth a) &lt;= (CommonMonth b) = a &lt;= b
  (CommonMonth a) &lt;= (LeapMonth b) = a &lt;= b
  (LeapMonth a) &lt;= (CommonMonth b) = a /= b &amp;&amp; a &lt;= b
  (LeapMonth a) &lt;= (LeapMonth b) = a &lt;= b

instance JapaneseName TempoMonth where
  toJapaneseName (CommonMonth monthType) = toJapaneseName monthType
  toJapaneseName (LeapMonth monthType) = &quot;&#38287;&quot; ++ toJapaneseName monthType
  fromJapaneseName name = toTempoMonth &lt;$&gt; fromJapaneseName ordinalName
    where
      isLeapMonthName = &quot;&#38287;&quot; `isPrefixOf` name
      ordinalName = if isLeapMonthName then tail name else name
      toTempoMonth = if isLeapMonthName then LeapMonth else CommonMonth

-- | a date in the Tempo calendar
data TempoDate = TempoDate { tempoYear :: Integer, tempoMonth :: TempoMonth, tempoDay :: Int } deriving (Show, Eq, Ord)

-- | gets a number of a month which starts from one
monthNumber :: TempoMonth -&gt; Int
monthNumber = (+ 1) . fromEnum . tempoMonthType

-- | tests whether a month is a leap month
isLeapMonth :: TempoMonth -&gt; Bool
isLeapMonth (CommonMonth _) = False
isLeapMonth (LeapMonth _) = True

-- | a cyclic successor of TempoMonthType
nextTempoMonthType :: TempoMonthType -&gt; TempoMonthType
nextTempoMonthType Shiwasu = Mutsuki
nextTempoMonthType monthType = succ monthType

-- | a cyclic predecessor of TempoMonthType
previousTempoMonthType :: TempoMonthType -&gt; TempoMonthType
previousTempoMonthType Mutsuki = Shiwasu
previousTempoMonthType monthType = pred monthType

data TempoMonthInterval = TempoMonthInterval { _intervalTempoMonth :: TempoMonth, _intervalFirstDay :: Day, _intervalLastDay :: Day }
data MonthSeed = MonthSeed { _seedFirstDay :: Day, _seedLastDay :: Day, _seedCenterPoints :: [SolarTerm] }

-- | converts a date into a date in the Tempo calendar
tempoDate :: TimeZone -&gt; Day -&gt; Maybe TempoDate
tempoDate zone day = do
  intervals &lt;- tempoMonthsInAYear zone day
  TempoMonthInterval month firstDay _ &lt;- find (\(TempoMonthInterval _ firstDay lastDay) -&gt; day &gt;= firstDay &amp;&amp; day &lt;= lastDay) intervals
  let (TempoMonthInterval _ shimotsukiFirst _) = head intervals
  let (shimotsukiYear, _, _) = toGregorian shimotsukiFirst
  let year = if month &gt;= CommonMonth Shimotsuki then shimotsukiYear else shimotsukiYear + 1
  return $ TempoDate year month (fromIntegral (diffDays day firstDay) + 1)

tempoMonthsInAYear :: TimeZone -&gt; Day -&gt; Maybe [TempoMonthInterval]
tempoMonthsInAYear zone day = singletonToMaybe (filter isLastKannazuki $ intervalCandidates seeds)
  where
    seeds = takeWhile (\(MonthSeed _ lastDay _) -&gt; lastDay &lt; nextYearWinterSolsticeDate) $ monthSeeds zone currentYearWinterSolsticeDate
    (currentYearWinterSolsticeDate, nextYearWinterSolsticeDate) = currentAndNextYearWinterSolticeDates zone day
    isLastKannazuki = (\(TempoMonthInterval month _ _) -&gt; tempoMonthType month == Kannazuki) . last
    singletonToMaybe [x] = Just x
    singletonToMaybe _ = Nothing

currentAndNextYearWinterSolticeDates :: TimeZone -&gt; Day -&gt; (Day, Day)
currentAndNextYearWinterSolticeDates zone day
  | isShimotsuki || nearest &lt;= day = (nearest, shiftNearest 365)
  | otherwise = (shiftNearest (-365), nearest)
  where
    nearest = findNearestSolarTerm zone WinterSolstice day
    isShimotsuki = latestNewMoonDate &lt;= nearest &amp;&amp; nextNewMoonDate &gt; nearest
    shiftNearest days = findNearestSolarTerm zone WinterSolstice $ addDays days nearest
    latestNewMoonDate : nextNewMoonDate : _ = newMoonDatesFrom zone day

intervalCandidates :: [MonthSeed] -&gt; [[TempoMonthInterval]]
intervalCandidates seeds = flip evalStateT Shimotsuki $ forM seeds $ \(MonthSeed firstDay lastDay centerPoints) -&gt;
  if null centerPoints
  then StateT $ \monthType -&gt;
    [ (TempoMonthInterval (CommonMonth monthType) firstDay lastDay, nextTempoMonthType monthType)
    , (TempoMonthInterval (LeapMonth (previousTempoMonthType monthType)) firstDay lastDay, monthType)
    ]
  else do
    monthType &lt;- get
    put (nextTempoMonthType monthType)
    if isValidCommonMonth centerPoints monthType
    then return $ TempoMonthInterval (CommonMonth monthType) firstDay lastDay
    else lift []

monthSeeds :: TimeZone -&gt; Day -&gt; [MonthSeed]
monthSeeds zone latestWinterSolsticeDate = collectMonthSeeds intervals allCenterPoints
  where
    firsts = newMoonDatesFrom zone latestWinterSolsticeDate
    intervals = zipWith (\first next -&gt; (first, addDays (-1) next)) firsts (tail firsts)
    allCenterPoints = centerPointsFrom zone latestWinterSolsticeDate

collectMonthSeeds :: [(Day, Day)] -&gt; [(SolarTerm, Day)] -&gt; [MonthSeed]
collectMonthSeeds ((firstDay, lastDay) : restIntervals) centerPoints = item : rest
  where
    item = MonthSeed firstDay lastDay (fst &lt;$&gt; centerPointsInMonth)
    rest = collectMonthSeeds restIntervals restCenterPoints
    (centerPointsInMonth, restCenterPoints) = span ((&lt;= lastDay) . snd) centerPoints
collectMonthSeeds [] _ = []

newMoonDatesFrom :: TimeZone -&gt; Day -&gt; [Day]
newMoonDatesFrom zone day = utcTimeToDay &lt;$&gt; unfoldr (\d -&gt; Just (d, succNewMoon d)) latest
  where
    utcStartTime = localTimeToUTC zone (LocalTime day midnight)
    addUTCDays days = addUTCTime $ fromRational $ days * 24 * 60 * 60
    nearest = nearestNewMoon utcStartTime
    latest =
      if nearest &lt;= addUTCDays 1 utcStartTime
      then nearest
      else nearestNewMoon $ addUTCDays (-averageMoonPhaseCycle) nearest
    succNewMoon = nearestNewMoon . addUTCDays averageMoonPhaseCycle
    utcTimeToDay utcTime = localDay $ utcToLocalTime zone utcTime

centerPointsFrom :: TimeZone -&gt; Day -&gt; [(SolarTerm, Day)]
centerPointsFrom zone day = filter (isCenterPoint . fst) $ solarTermsFrom zone day

isValidCommonMonth :: [SolarTerm] -&gt; TempoMonthType -&gt; Bool
isValidCommonMonth centerPoints monthType = maybe True (== monthType) $ listToMaybe $ mapMaybe centerPointToMonthType centerPoints
  where
    centerPointToMonthType WinterSolstice = Just Shimotsuki
    centerPointToMonthType VernalEquinox = Just Kisaragi
    centerPointToMonthType SummerSolstice = Just Satsuki
    centerPointToMonthType AutumnalEquinox = Just Hazuki
    centerPointToMonthType _ = Nothing
</span></pre></body></html>